"use strict";(self.webpackChunkhotoo_github_io=self.webpackChunkhotoo_github_io||[]).push([["740"],{9237:function(e,n,s){s.r(n),s.d(n,{default:()=>l});var r=s(4132),i=s(453);function h(e){let n=Object.assign({h1:"h1",a:"a",p:"p",h2:"h2",ol:"ol",li:"li",footer:"footer",div:"div",strong:"strong",cite:"cite"},(0,i.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"不缓存-cdn-静态资源方案",children:["不缓存 CDN 静态资源方案",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#不缓存-cdn-静态资源方案",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"支付宝目前使用淘宝提供的 CDN 服务，这个服务中的 CDN 节点在自身找不到对应资源时\n主动到源服务器拉取的策略。"}),"\n",(0,r.jsx)(n.p,{children:"支付宝使用的静态资源合并(combo)方案，导致在不同的访问参数情况下，被认为是不同\n的静态资源。如果挟带的是避免缓存的随机参数，CDN 在没有缓存这个资源的情况下，\n会到源服务器拉取资源。"}),"\n",(0,r.jsx)(n.p,{children:"原则上，我们使用特定的版本机制，每个新版本文件以不同的文件名发布，不允许使用\n参数，尤其是随机数方式避免缓存问题。"}),"\n",(0,r.jsxs)(n.h2,{id:"问题",children:["问题",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#问题",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"由于我们使用的版本策略，我们可以指定用户缓存静态资源时效为永久，实际方案上\n我们指定用户缓存时间为 1年，但是在某些场景下（如测量用户网络速度），\n用户客户端（非 CDN 节点）访问某些特定静态资源需要禁止使用缓存。"}),"\n",(0,r.jsx)(n.p,{children:"目前常见的方案都是在客户端使用时间戳+随机数。这个方案本身看似没什么问题，但是\n实际上有非常大的隐患，测量的数据参考性也不佳。"}),"\n",(0,r.jsx)(n.p,{children:"\\n CDN 节点上缓存了大量挟带永不重复随机数的资源，对磁盘造成影响。\n\\n CDN 缓存命中率降低，这些挟带随机数的静态资源缓存率命中率为 0。\n\\n 增加源服务器的访问压力。\n\\n 测量的用户网络响应时间实际不是到 CDN 节点的，还包含 CDN 回源的时间。"}),"\n",(0,r.jsxs)(n.h2,{id:"解决方案",children:["解决方案",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#解决方案",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"为了解决这种明确不允许用户客户端缓存，同时又不建议使用随机参数访问的需求，我们\n有以下几种方案："}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"CDN 服务器端控制浏览器不缓存。『最佳方案』"}),"\n",(0,r.jsx)(n.p,{children:"设置指定目录下的静态资源禁止缓存头信息，有需要禁止缓存需求时上传静态资源到\n这个目录。"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"直接访问源服务器。"}),"\n",(0,r.jsx)(n.p,{children:"现在的加随机数访问 CDN 方案和直接访问源服务器本质上相同，这方案只能测用户到\n源服务器的响应时间。"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"使用有限随机数方案。"}),"\n",(0,r.jsx)(n.p,{children:"虽然第一种是最佳方案，但也不排除某些浏览器或壳在不关闭页面情况下，有缓存的\n问题，所以这和第一种方案结合使用可能是更靠谱一些的方案。『待验证』"}),"\n",(0,r.jsx)(n.p,{children:"页面脚本请求静态资源时，带上从零递增的参数，避免单页面缓存问题，亦可避免\nCDN 缓存大量无意义资源的问题。"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.h2,{id:"延伸",children:["延伸",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#延伸",children:"#"})]}),"\n",(0,r.jsx)(n.p,{children:"实际上，对于静态资源来说，纯粹的参数是无意义的，CDN 节点本可以忽略这个参数。\n虽然合并策略使用了参数方式，但是我们使用双问号激活合并服务的方案可以让我们\n明确区分出合并参数和其他参数，因此技术上是完全可以忽略其他参数导致的回源。"}),"\n",(0,r.jsxs)(n.h2,{id:"参考",children:["参考",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#参考",children:"#"})]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://segmentfault.com/q/1010000000119794",target:"_blank",rel:"noopener noreferrer",children:"拉取式相比推送式的对比的参考"})}),"\n",(0,r.jsxs)("footer",{class:"blog-post-footer",children:[(0,r.jsx)("div",{class:"blog-post-footer-meta meta-left",children:(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Tags:"})," ",(0,r.jsx)("a",{href:"/blog/tags/Web-Design",children:(0,r.jsx)("cite",{class:"tags",children:"Web-Design"})}),", ",(0,r.jsx)("a",{href:"/blog/tags/CDN",children:(0,r.jsx)("cite",{class:"tags",children:"CDN"})})]})}),(0,r.jsx)("div",{class:"blog-post-footer-meta meta-right",children:(0,r.jsxs)(n.p,{children:["Published on ",(0,r.jsx)("cite",{class:"date",children:"2013-09-21"})]})})]}),"\n"]}),"\n"]})]})}function d(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,i.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}let l=d;d.__RSPRESS_PAGE_META={},d.__RSPRESS_PAGE_META["..%2Fnode_modules%2F.rspress%2Fruntime%2Ftemp-45.mdx"]={toc:[{text:"问题",id:"问题",depth:2},{text:"解决方案",id:"解决方案",depth:2},{text:"延伸",id:"延伸",depth:2},{text:"参考",id:"参考",depth:2}],title:"不缓存 CDN 静态资源方案",headingTitle:"不缓存 CDN 静态资源方案",frontmatter:{category:null,tags:"Web-Design, CDN",date:"2013-09-21T00:00:00.000Z"}}}}]);
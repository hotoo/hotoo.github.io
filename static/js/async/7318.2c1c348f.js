"use strict";(self.webpackChunkhotoo_co=self.webpackChunkhotoo_co||[]).push([["7318"],{7655:function(n,e,s){s.r(e),s.d(e,{default:()=>c});var r=s(4132),l=s(453),i=s(3030);function t(n){let e=Object.assign({h1:"h1",a:"a",p:"p",img:"img",ul:"ul",li:"li",table:"table",thead:"thead",tr:"tr",th:"th",tbody:"tbody",td:"td",pre:"pre",code:"code",ol:"ol",h2:"h2",footer:"footer",div:"div",strong:"strong",cite:"cite"},(0,l.ah)(),n.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(e.h1,{id:"每周异常第-4期如何避免客户端攻击造成的大量异常报警",children:["每周异常：第 4期，如何避免客户端攻击造成的大量异常报警",(0,r.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#每周异常第-4期如何避免客户端攻击造成的大量异常报警",children:"#"})]}),"\n",(0,r.jsx)(e.p,{children:"在 JavaScript 异常监控过程中，发现有很多由于客户端连续攻击造成的大量异常，导致\n监控系统报警。"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"https://f.cloud.github.com/assets/143572/921735/fe39d910-ff04-11e2-93f2-ca5bb222be8f.png",alt:"2013-08-07 9 58 37"})}),"\n",(0,r.jsx)(e.p,{children:"（图中大量不连续的波动，都是攻击造成的）"}),"\n",(0,r.jsx)(e.p,{children:"这种少量用户(UV)发起攻击造成的大量异常(PV)波动，不是我们实时监控需要关注的部分。\n我们实时监控最重要的是要发现由于系统发布过程中，我们的发布的代码有问题导致大量\n用户受影响而出现的波动（波形可能跟上图的每一个异常波形相似）。"}),"\n",(0,r.jsx)(e.p,{children:"理论上导致异常数据波动的场景包括："}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"少量用户发起大量攻击。"}),"\n",(0,r.jsx)(e.li,{children:"大量用户同时涌入或离开。"}),"\n",(0,r.jsx)(e.li,{children:"发布问题代码影响到大量用户。"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"少量用户发起大量攻击造成数据波动，是我们可以不必实时关注实时报警的部分。"}),"\n",(0,r.jsx)(e.p,{children:"大量用户同时涌入或离开造成的异常数量(PV)波动，也是我们无需实时关注的部分，\n另外我们也可以通过异常率规避波动。"}),"\n",(0,r.jsxs)(e.table,{children:["\n",(0,r.jsxs)(e.thead,{children:["\n",(0,r.jsxs)(e.tr,{children:["\n",(0,r.jsx)(e.th,{children:"场景"}),"\n",(0,r.jsx)(e.th,{children:"异常 PV"}),"\n",(0,r.jsx)(e.th,{children:"异常 UV"}),"\n",(0,r.jsx)(e.th,{children:"异常率(PV)"}),"\n",(0,r.jsx)(e.th,{children:"异常率(UV)"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.tbody,{children:["\n",(0,r.jsxs)(e.tr,{children:["\n",(0,r.jsx)(e.td,{children:"攻击"}),"\n",(0,r.jsx)(e.td,{children:"波动"}),"\n",(0,r.jsx)(e.td,{children:"无波动"}),"\n",(0,r.jsx)(e.td,{children:"波动"}),"\n",(0,r.jsx)(e.td,{children:"无波动"}),"\n"]}),"\n",(0,r.jsxs)(e.tr,{children:["\n",(0,r.jsx)(e.td,{children:"涌入"}),"\n",(0,r.jsx)(e.td,{children:"波动"}),"\n",(0,r.jsx)(e.td,{children:"波动"}),"\n",(0,r.jsx)(e.td,{children:"无波动"}),"\n",(0,r.jsx)(e.td,{children:"无波动"}),"\n"]}),"\n",(0,r.jsxs)(e.tr,{children:["\n",(0,r.jsx)(e.td,{children:"发布"}),"\n",(0,r.jsx)(e.td,{children:"波动"}),"\n",(0,r.jsx)(e.td,{children:"波动"}),"\n",(0,r.jsx)(e.td,{children:"波动"}),"\n",(0,r.jsx)(e.td,{children:"波动"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"注："}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"异常率(PV) = 异常PV / 所在页面PV"}),"\n",(0,r.jsx)(e.li,{children:"异常率(UV) = 异常UV / 所在页面UV"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"从上面的对照表可以看出，理论上我们只需要关注异常率(UV) 是否正常波动就可以了。"}),"\n",(0,r.jsx)(e.p,{children:"理想很性感，现实很骨感。"}),"\n",(0,r.jsx)(e.p,{children:"我们的数据仓库、数据分析系统对于实时 PV 有很强的处理能力，但是对于 UV 就感觉力有不逮。"}),"\n",(0,r.jsx)(e.p,{children:"起初想到在实时日志处理逻辑中使用缓存（伪代码）："}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-js",children:'class LogParse(){\n\n  var user_cache = {};\n  var MINUTES_FORMAT = "YYYYMMDDHHmm";\n  var lastTime = moment().format(MINUTES_FORMAT);\n\n  function parse(log){\n    // PV 统计\n\n    var now = moment().format(MINUTES_FORMAT);\n    if(now !== lastTime){\n      user_cache = {};\n      lastTime = now;\n    }\n    if(user_cache.hasOwnProperty(user_id)){return;}\n    // UV 统计\n  }\n\n}\n'})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"但是实时数据分析系统是分布式的，由多台服务器组成的集群同时处理日志，所以里面\n的内部状态只有本机有效"}),"\n",(0,r.jsx)(e.li,{children:"另外更致命的是，实时数据分析系统是无状态的，下次执行会 new 新的 LogParser 实例，\n同一台机器的状态也保证不了。"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"于是我们又想到一种从客户端来标识用户的方法："}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"客户端单位时间内同一个页面抛出的同一个异常，第一次打上 uv 标记。"}),"\n",(0,r.jsx)(e.li,{children:"数据处理时遇到 uv 标记的日志，同时统计算做一个异常 uv。"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"由于客户端时间和服务端有时间差，每个客户端时间和服务端时间差也不一致，导致这种\n方案会有稍大误差，但也基本能解决问题。"}),"\n",(0,r.jsx)(e.p,{children:"但是要在客户端打标记，则需要在客户端（cookie 或其他本地存储）记录每个异常\n（url, file, line, message 相同被当作同一个异常）最后抛出的时间，每次抛出异常\n都需要读写本地存储，稍嫌臃肿。"}),"\n",(0,r.jsx)(e.p,{children:"通过深入分析实际的攻击案例，发现攻击引发大量异常的场景中，客户端页面是不刷新或\n重新访问的，都是直接在当前访问的页面执行上批量脚本。"}),"\n",(0,r.jsx)(e.p,{children:"因此我们可以使用局部变量，将当前访问的页面的每个异常最后抛出时间记录在内存中，\n重新访问页面则重新开始记录。"}),"\n",(0,r.jsx)(e.p,{children:"这种方案对于防范攻击造成的大量异常非常有效；对于大量用户涌入引起的异常也有一定\n效用，毕竟正常用户较少会频繁触发异常。"}),"\n",(0,r.jsx)(e.p,{children:"总之，通过这个方案，我们可以非常有效的实时监控异常波动，较少误报。"}),"\n",(0,r.jsx)(e.p,{children:"p.s. 这个想法是早上洗澡的时候想到的，还没开始实践。但是我信心满满写下这篇，\n数据会来证明我是对的。"}),"\n",(0,r.jsxs)(e.h2,{id:"续-on-2013-08-20",children:["续 on 2013-08-20",(0,r.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#续-on-2013-08-20",children:"#"})]}),"\n",(0,r.jsx)(e.p,{children:"是时候结帐了。正好发布一天，大家看数据："}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{src:"https://f.cloud.github.com/assets/143572/991796/2e2038c2-096e-11e3-9008-e21d3b9e354a.png",alt:"2013-08-20 3 55 10"})}),"\n",(0,r.jsx)(e.p,{children:"图中的灰色竖线是发布点，橙色是 JavaScript 异常，绿色是静态资源异常。"}),"\n",(0,r.jsx)(e.p,{children:"妈妈再也不用担心我的手机会收到误报的报警短信了。"}),"\n",(0,r.jsxs)("footer",{class:"blog-post-footer",children:[(0,r.jsx)("div",{class:"blog-post-footer-meta meta-left",children:(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Tags:"})," ",(0,r.jsx)("a",{href:"/blog/tags/%E6%AF%8F%E5%91%A8%E5%BC%82%E5%B8%B8",children:(0,r.jsx)("cite",{class:"tags",children:"每周异常"})})]})}),(0,r.jsx)("div",{class:"blog-post-footer-meta meta-right",children:(0,r.jsxs)(e.p,{children:["Published on ",(0,r.jsx)("cite",{class:"date",children:"2013-08-07"})]})})]}),"\n",(0,r.jsx)(i.DiscussionEmbed,{shortname:"hotoo",config:{url:"https://hotoo.co/blog/post/weekly-topic-about-exceptions-4.html",identifier:"/blog/post/weekly-topic-about-exceptions-4.html",title:"每周异常：第 4期，如何避免客户端攻击造成的大量异常报警",language:"zh_CN"}})]})}function d(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:e}=Object.assign({},(0,l.ah)(),n.components);return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(t,{...n})}):t(n)}let c=d;d.__RSPRESS_PAGE_META={},d.__RSPRESS_PAGE_META["..%2Fnode_modules%2F.rspress%2Fruntime%2Ftemp-51.mdx"]={toc:[{text:"续 on 2013-08-20",id:"续-on-2013-08-20",depth:2}],title:"每周异常：第 4期，如何避免客户端攻击造成的大量异常报警",headingTitle:"每周异常：第 4期，如何避免客户端攻击造成的大量异常报警",frontmatter:{category:null,tags:"每周异常",date:"2013-08-07T00:00:00.000Z",sidebar:!1,footer:!1}}}}]);